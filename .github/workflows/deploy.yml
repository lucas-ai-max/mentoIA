name: Deploy to Cloud Run

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
      
      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker southamerica-east1-docker.pkg.dev
      
      - name: Set project and configure
        run: |
          echo "PROJECT_ID=80767420742" >> $GITHUB_ENV
          echo "REGION=southamerica-east1" >> $GITHUB_ENV
          echo "SERVICE_NAME=mentoia-api" >> $GITHUB_ENV
          echo "REPOSITORY=docker-repo" >> $GITHUB_ENV
          
          # Configurar projeto padrão
          gcloud config set project 80767420742
      
      - name: Build and Push Docker image
        run: |
          PROJECT_ID="80767420742"
          REGION="southamerica-east1"
          REPOSITORY="docker-repo"
          SERVICE_NAME="mentoia-api"
          IMAGE_NAME="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPOSITORY}/${SERVICE_NAME}:${{ github.sha }}"
          
          echo "Building image: ${IMAGE_NAME}"
          
          # Criar repositório se não existir
          gcloud artifacts repositories create ${REPOSITORY} \
            --repository-format=docker \
            --location=${REGION} \
            --description="Docker repository for mentoia-api" \
            --project=${PROJECT_ID} || true
          
          # Build da imagem
          docker build -t ${IMAGE_NAME} .
          
          # Push para Artifact Registry
          docker push ${IMAGE_NAME}
          
          echo "IMAGE_NAME=${IMAGE_NAME}" >> $GITHUB_ENV
      
      - name: Deploy to Cloud Run
        run: |
          PROJECT_ID="80767420742"
          REGION="southamerica-east1"
          SERVICE_NAME="mentoia-api"
          REPOSITORY="docker-repo"
          IMAGE_NAME="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPOSITORY}/${SERVICE_NAME}:${{ github.sha }}"
          
          echo "Deploying service: ${SERVICE_NAME}"
          echo "Image: ${IMAGE_NAME}"
          echo "Region: ${REGION}"
          echo "Project: ${PROJECT_ID}"
          
          gcloud run deploy ${SERVICE_NAME} \
            --image ${IMAGE_NAME} \
            --region ${REGION} \
            --platform managed \
            --project ${PROJECT_ID} \
            --allow-unauthenticated \
            --memory 2Gi \
            --cpu 2 \
            --timeout 600 \
            --cpu-boost \
            --max-instances 10 \
            --set-env-vars ^##^ALLOWED_ORIGINS="${{ secrets.ALLOWED_ORIGINS }}"^##^SUPABASE_URL="${{ secrets.SUPABASE_URL }}"^##^SUPABASE_SERVICE_ROLE_KEY="${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}"^##^OPENAI_API_KEY=placeholder^##^ANTHROPIC_API_KEY=placeholder^##^GOOGLE_API_KEY=placeholder^##^CREWAI_TELEMETRY_OPT_OUT=true^##^OTEL_SDK_DISABLED=true
